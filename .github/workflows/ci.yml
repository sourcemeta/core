name: JSON Toolkit

on:
  schedule:
    # Once per day, Monday to Friday
    - cron: '0 19 * * 1-5'
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: macos-latest
            compiler: llvm
            type: static
          - os: macos-latest
            compiler: llvm
            type: shared
          - os: ubuntu-latest
            compiler: llvm
            type: static
          - os: ubuntu-latest
            compiler: gcc
            type: static
          - os: ubuntu-latest
            compiler: llvm
            type: shared
          - os: ubuntu-latest
            compiler: gcc
            type: shared
          - os: windows-latest
            compiler: msvc
            type: static
          - os: windows-latest
            compiler: msvc
            type: shared

          # Sanitizers
          - os: ubuntu-latest
            compiler: llvm
            type: static
            options: -DJSONTOOLKIT_ADDRESS_SANITIZER:BOOL=ON
          - os: ubuntu-latest
            compiler: llvm
            type: static
            options: -DJSONTOOLKIT_UNDEFINED_SANITIZER:BOOL=ON

    runs-on: ${{ matrix.platform.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Installing dependencies
        uses: sourcemeta/noa@bf776e10ed7d4a056627923eb9bf6ff61a38e92b
        with:
          step: dependencies
      - name: Configuring
        uses: sourcemeta/noa@bf776e10ed7d4a056627923eb9bf6ff61a38e92b
        with:
          step: configure
          mode: ${{ matrix.platform.type }}
          compiler: ${{ matrix.platform.compiler }}
          options: -DJSONTOOLKIT_TESTS:BOOL=ON -DJSONTOOLKIT_DOCS:BOOL=OFF ${{ matrix.platform.options }}
      - name: Check
        uses: sourcemeta/noa@bf776e10ed7d4a056627923eb9bf6ff61a38e92b
        with:
          step: check
      - name: Build
        uses: sourcemeta/noa@bf776e10ed7d4a056627923eb9bf6ff61a38e92b
        with:
          step: build
      - name: Install
        uses: sourcemeta/noa@bf776e10ed7d4a056627923eb9bf6ff61a38e92b
        with:
          step: install
          component: jsontoolkit
      - name: Test
        uses: sourcemeta/noa@bf776e10ed7d4a056627923eb9bf6ff61a38e92b
        with:
          step: test

  unikraft:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: unikraft/kraftkit@stable
        with:
          workdir: .
          run: |
            kraft build --target development --jobs 4 --log-type=basic unikraft
            kraft run --target development --disable-acceleration unikraft --memory 128Mi
